<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Wise Owl - Health Monitoring Dashboard</title>
		<style>
			body {
				font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
				margin: 0;
				padding: 20px;
				background-color: #f5f5f5;
			}
			.header {
				text-align: center;
				margin-bottom: 30px;
			}
			.header h1 {
				color: #2c3e50;
				margin: 0;
			}
			.header p {
				color: #7f8c8d;
				margin: 5px 0;
			}
			.dashboard {
				max-width: 1200px;
				margin: 0 auto;
			}
			.service-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
				gap: 20px;
				margin-bottom: 30px;
			}
			.service-card {
				background: white;
				border-radius: 8px;
				padding: 20px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
				border-left: 4px solid #3498db;
			}
			.service-card.healthy {
				border-left-color: #27ae60;
			}
			.service-card.unhealthy {
				border-left-color: #e74c3c;
			}
			.service-card.loading {
				border-left-color: #f39c12;
			}
			.service-title {
				font-size: 18px;
				font-weight: bold;
				margin-bottom: 10px;
				color: #2c3e50;
			}
			.service-status {
				display: flex;
				align-items: center;
				margin-bottom: 10px;
			}
			.status-indicator {
				width: 12px;
				height: 12px;
				border-radius: 50%;
				margin-right: 8px;
			}
			.status-indicator.healthy {
				background-color: #27ae60;
			}
			.status-indicator.unhealthy {
				background-color: #e74c3c;
			}
			.status-indicator.loading {
				background-color: #f39c12;
			}
			.service-details {
				font-size: 14px;
				color: #7f8c8d;
			}
			.service-details div {
				margin: 5px 0;
			}
			.gateway-section {
				background: white;
				border-radius: 8px;
				padding: 20px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
				margin-bottom: 30px;
			}
			.gateway-title {
				font-size: 20px;
				font-weight: bold;
				margin-bottom: 15px;
				color: #2c3e50;
			}
			.refresh-button {
				background-color: #3498db;
				color: white;
				border: none;
				padding: 10px 20px;
				border-radius: 5px;
				cursor: pointer;
				font-size: 14px;
				margin-bottom: 20px;
			}
			.refresh-button:hover {
				background-color: #2980b9;
			}
			.last-updated {
				text-align: center;
				color: #7f8c8d;
				font-size: 12px;
				margin-top: 20px;
			}
			.error-message {
				background-color: #e74c3c;
				color: white;
				padding: 10px;
				border-radius: 5px;
				margin: 10px 0;
			}
		</style>
	</head>
	<body>
		<div class="header">
			<h1>ðŸ¦‰ Wise Owl Health Monitoring</h1>
			<p>Microservices Health Dashboard</p>
			<button class="refresh-button" onclick="refreshDashboard()">
				ðŸ”„ Refresh Status
			</button>
		</div>

		<div class="dashboard">
			<!-- Gateway Status -->
			<div class="gateway-section">
				<div class="gateway-title">API Gateway Status</div>
				<div id="gateway-status">Loading...</div>
			</div>

			<!-- Services Grid -->
			<div class="service-grid" id="services-grid">
				<!-- Services will be populated here -->
			</div>

			<div class="last-updated" id="last-updated">Last updated: Loading...</div>
		</div>

		<script>
			const services = [
				{
					name: "Users Service",
					healthUrl: "/api/v1/users/health",
					readyUrl: "/api/v1/users/health/ready",
					directUrl: "http://localhost:8081/health/",
				},
				{
					name: "Content Service",
					healthUrl: "/api/v1/content/health",
					readyUrl: "/api/v1/content/health/ready",
					directUrl: "http://localhost:8082/health/",
				},
				{
					name: "Quiz Service",
					healthUrl: "/api/v1/quiz/health",
					readyUrl: "/api/v1/quiz/health/ready",
					directUrl: "http://localhost:8083/health/",
				},
			];

			const gatewayUrl = "/health-check";

			async function checkServiceHealth(service) {
				try {
					const response = await fetch(service.healthUrl);
					const data = await response.json();

					return {
						status: response.ok ? "healthy" : "unhealthy",
						data: data,
						httpStatus: response.status,
					};
				} catch (error) {
					return {
						status: "unhealthy",
						error: error.message,
						httpStatus: 0,
					};
				}
			}

			async function checkGatewayHealth() {
				try {
					const response = await fetch(gatewayUrl);
					const data = await response.json();

					return {
						status: response.ok ? "healthy" : "unhealthy",
						data: data,
						httpStatus: response.status,
					};
				} catch (error) {
					return {
						status: "unhealthy",
						error: error.message,
						httpStatus: 0,
					};
				}
			}

			function renderGatewayStatus(gatewayHealth) {
				const gatewayDiv = document.getElementById("gateway-status");

				if (gatewayHealth.status === "healthy") {
					gatewayDiv.innerHTML = `
                    <div class="service-status">
                        <div class="status-indicator healthy"></div>
                        <span>Nginx API Gateway - Healthy</span>
                    </div>
                    <div class="service-details">
                        <div>Service: ${gatewayHealth.data.service}</div>
                        <div>Status: ${gatewayHealth.data.status}</div>
                        <div>HTTP Status: ${gatewayHealth.httpStatus}</div>
                    </div>
                `;
				} else {
					gatewayDiv.innerHTML = `
                    <div class="service-status">
                        <div class="status-indicator unhealthy"></div>
                        <span>Nginx API Gateway - Unhealthy</span>
                    </div>
                    <div class="error-message">
                        Error: ${gatewayHealth.error || "Unknown error"}
                    </div>
                `;
				}
			}

			function renderServices(servicesHealth) {
				const grid = document.getElementById("services-grid");
				grid.innerHTML = "";

				servicesHealth.forEach((serviceHealth, index) => {
					const service = services[index];
					const card = document.createElement("div");
					card.className = `service-card ${serviceHealth.status}`;

					if (serviceHealth.status === "healthy") {
						card.innerHTML = `
                        <div class="service-title">${service.name}</div>
                        <div class="service-status">
                            <div class="status-indicator healthy"></div>
                            <span>Healthy</span>
                        </div>
                        <div class="service-details">
                            <div><strong>Status:</strong> ${
															serviceHealth.data.status
														}</div>
                            <div><strong>Uptime:</strong> ${
															serviceHealth.data.uptime || "N/A"
														}</div>
                            <div><strong>Database:</strong> ${
															serviceHealth.data.database || "N/A"
														}</div>
                            <div><strong>Last Check:</strong> ${new Date(
															serviceHealth.data.timestamp
														).toLocaleTimeString()}</div>
                            <div><strong>HTTP Status:</strong> ${
															serviceHealth.httpStatus
														}</div>
                        </div>
                    `;
					} else {
						card.innerHTML = `
                        <div class="service-title">${service.name}</div>
                        <div class="service-status">
                            <div class="status-indicator unhealthy"></div>
                            <span>Unhealthy</span>
                        </div>
                        <div class="error-message">
                            Error: ${
															serviceHealth.error || "Service unavailable"
														}
                            <br>HTTP Status: ${serviceHealth.httpStatus}
                        </div>
                        <div class="service-details">
                            <div><strong>Health URL:</strong> ${
															service.healthUrl
														}</div>
                            <div><strong>Direct URL:</strong> ${
															service.directUrl
														}</div>
                        </div>
                    `;
					}

					grid.appendChild(card);
				});
			}

			async function refreshDashboard() {
				document.getElementById("last-updated").textContent =
					"Last updated: Refreshing...";

				// Set services to loading state
				const grid = document.getElementById("services-grid");
				grid.innerHTML = services
					.map(
						(service) => `
                <div class="service-card loading">
                    <div class="service-title">${service.name}</div>
                    <div class="service-status">
                        <div class="status-indicator loading"></div>
                        <span>Checking...</span>
                    </div>
                </div>
            `
					)
					.join("");

				try {
					// Check all services in parallel
					const [gatewayHealth, ...servicesHealth] = await Promise.all([
						checkGatewayHealth(),
						...services.map(checkServiceHealth),
					]);

					renderGatewayStatus(gatewayHealth);
					renderServices(servicesHealth);

					document.getElementById(
						"last-updated"
					).textContent = `Last updated: ${new Date().toLocaleString()}`;
				} catch (error) {
					document.getElementById(
						"last-updated"
					).textContent = `Last updated: Error - ${error.message}`;
				}
			}

			// Auto-refresh every 30 seconds
			setInterval(refreshDashboard, 30000);

			// Initial load
			refreshDashboard();
		</script>
	</body>
</html>
